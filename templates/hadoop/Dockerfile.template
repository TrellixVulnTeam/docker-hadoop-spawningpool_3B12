FROM openjdk:{{additional["dependency-versions"]["java"]}}-jdk-slim

MAINTAINER Mun Duk Hyun <dev.moonduck@gmail.com>

# Install dependencies
ENV ZOOKEEPER_HOME=/opt/zookeeper
ENV HADOOP_HOME=/opt/hadoop-{{additional["dependency-versions"]["hadoop"]}}
ENV HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop
ENV PATH=$HADOOP_HOME/bin/:$PATH

RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
      net-tools \
      curl \
      netcat \
      gnupg \
      libsnappy-dev \
      procps \
      python3 \
    && rm -rf /var/lib/apt/lists/* \
    && mkdir /opt/hadoop-{{additional["dependency-versions"]["hadoop"]}}/logs \
    && mkdir -p /hadoop-data/ && mkdir -p /prerun && mkdir -p /postrun && mkdir -p /config && mkdir -p /scripts && mkdir -p /env

# Zookeeper
COPY --from=zookeeper:3.6.2 /apache-zookeeper-3.6.2-bin $ZOOKEEPER_HOME
COPY ./conf/zoo.cfg $ZOOKEEPER_HOME/conf/zoo.cfg

# Define linux user and groups for hadoop users
RUN {% for name, gid in additional["groups"].items() -%}
    {% if loop.first is false %}&&{% endif %} groupadd --gid {{gid}} {{name}} \
{% endfor %}{% for name, user in additional["users"].items() -%}
    && useradd --uid {{user['uid']}} --no-log-init -G {{user['groups']|join(",")}} --shell /bin/bash -p {{name}} {{name}} {% if loop.last is false %}\{% endif %}
{% endfor -%}

COPY scripts/ /scripts/
COPY ./conf/core-site.xml $HADOOP_CONF_DIR/core-site.xml
COPY ./conf/hdfs-site.xml $HADOOP_CONF_DIR/hdfs-site.xml
COPY ./conf/yarn-site.xml $HADOOP_CONF_DIR/yarn-site.xml
COPY ./conf/mapred-site.xml $HADOOP_CONF_DIR/mapred-site.xml

RUN mkdir -p /hadoop/dfs/name \
    && mkdir -p /hadoop/dfs/data \
    && mkdir -p /hadoop/yarn/timeline \
    && mkdir -p /hadoop/dfs/data \
    && mkdir -p /opt/zookeeper/data

ENTRYPOINT ["/scripts/entrypoint.sh"]

CMD ["/bin/bash"]
